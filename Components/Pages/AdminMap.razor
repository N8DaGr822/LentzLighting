@page "/admin-map"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using LentzLighting.Models
@using LentzLighting.Data
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Policy = "AdminOnly")]
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject SignInManager<ApplicationUser> SignInManager
@inject ApplicationDbContext DbContext

<PageTitle>Admin Map - Lentz Lighting</PageTitle>
<HeadContent>
    <meta name="robots" content="noindex, nofollow" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="admin-map.js"></script>
</HeadContent>

<div class="admin-hero">
        <div class="container">
            <div class="admin-header">
                <div>
                    <h1 class="admin-title">Service Area Map</h1>
                    <p class="admin-subtitle">Track installations, customers, and service areas</p>
                </div>
                <div class="admin-actions">
                    <button class="btn btn-outline" @onclick="HandleLogout">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="map-section">
        <div class="container">
            <div class="map-controls">
                <div class="control-group">
                    <label>Map Layer:</label>
                    <select @bind="selectedLayer" @bind:after="UpdateMapLayer">
                        <option value="all">All Locations</option>
                        <option value="Premium Package">Premium Package</option>
                        <option value="Residential">Residential</option>
                        <option value="Custom Design">Custom Design</option>
                        <option value="Basic Package">Basic Package</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Service Areas">Service Areas</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Status Filter:</label>
                    <select @bind="selectedStatus" @bind:after="UpdateMapLayer">
                        <option value="all">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="scheduled">Scheduled</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Map Actions:</label>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline" @onclick="FitMapToMarkers">
                            üéØ Fit to Markers
                        </button>
                        <button class="btn btn-sm btn-outline" @onclick="ClearRouting">
                            üóëÔ∏è Clear Routes
                        </button>
                    </div>
                </div>
                
                <button class="btn btn-primary" @onclick="AddNewLocation">
                    üìç Add New Location
                </button>
            </div>
            
            <div class="map-container">
                <div id="map" class="map"></div>
                
                <div class="map-sidebar">
                    <div class="sidebar-header">
                        <h3>Location Details</h3>
                        <button class="btn btn-sm btn-outline" @onclick="CloseSidebar">‚úï</button>
                    </div>
                    
                    @if (selectedLocation != null)
                    {
                        <div class="location-details">
                            <div class="location-header">
                                <h4>@selectedLocation.Name</h4>
                                <span class="status @selectedLocation.Status">@selectedLocation.Status</span>
                            </div>
                            
                            <div class="location-info">
                                <p><strong>Address:</strong> @selectedLocation.Address</p>
                                <p><strong>Customer:</strong> @selectedLocation.CustomerName</p>
                                <p><strong>Service:</strong> @selectedLocation.ServiceType</p>
                                <p><strong>Date:</strong> @selectedLocation.Date.ToString("MMM dd, yyyy")</p>
                                <p><strong>Value:</strong> $@selectedLocation.Value</p>
                            </div>
                            
                            <div class="location-actions">
                                <button class="btn btn-sm btn-primary">Edit</button>
                                <button class="btn btn-sm btn-outline">View Details</button>
                                <button class="btn btn-sm btn-outline">Contact Customer</button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="no-selection">
                            <p>Select a location on the map to view details</p>
                        </div>
                    }
                </div>
            </div>
            
            <div class="map-stats">
                <div class="stat-card">
                    <div class="stat-icon">üìç</div>
                    <div class="stat-content">
                        <h3>@totalLocations</h3>
                        <p>Total Locations</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <h3>@completedInstallations</h3>
                        <p>Completed</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-content">
                        <h3>@pendingInstallations</h3>
                        <p>Pending</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-content">
                        <h3>$@totalValue</h3>
                        <p>Total Value</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

@code {
    private string selectedLayer = "all";
    private string selectedStatus = "all";
    private MapLocation? selectedLocation = null;
    
    private int totalLocations = 0;
    private int completedInstallations = 0;
    private int pendingInstallations = 0;
    private int totalValue = 0;

    private List<MapLocation> locations = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLocations();
    }

    private async Task LoadLocations()
    {
        try
        {
            locations = await DbContext.MapLocations.ToListAsync();
            
            // Calculate statistics
            totalLocations = locations.Count;
            completedInstallations = locations.Count(l => l.Status == "completed");
            pendingInstallations = locations.Count(l => l.Status == "pending" || l.Status == "scheduled");
            totalValue = locations.Sum(l => l.Value);
        }
        catch
        {
            // Error loading - use defaults
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Wait for the script to load
                await Task.Delay(500);
                
                // Check if the function is available
                var functionExists = await JSRuntime.InvokeAsync<bool>("eval", "typeof initializeMap !== 'undefined'");
                
                if (functionExists)
                {
                    await InitializeMap();
                }
            }
            catch
            {
                // Error loading script - map will not initialize
            }
        }
    }

    private async Task InitializeMap()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("initializeMap", locations, DotNetObjectReference.Create(this));
        }
        catch (Exception ex)
        {
            // Log error silently - could be enhanced with proper logging
            _ = ex;
        }
    }

    private async Task UpdateMapLayer()
    {
        var filteredLocations = locations.Where(l => 
            (selectedLayer == "all" || selectedLayer == l.ServiceType) &&
            (selectedStatus == "all" || selectedStatus == l.Status)
        ).ToList();
        
        await JSRuntime.InvokeVoidAsync("updateMapMarkers", filteredLocations);
    }

    private async Task FitMapToMarkers()
    {
        await JSRuntime.InvokeVoidAsync("fitMapToMarkers");
    }

    private async Task ClearRouting()
    {
        await JSRuntime.InvokeVoidAsync("clearRouting");
    }

    private void AddNewLocation()
    {
        // TODO: Implement add new location functionality
    }

    private void CloseSidebar()
    {
        selectedLocation = null;
        StateHasChanged();
    }

    private async Task HandleLogout()
    {
        await SignInManager.SignOutAsync();
        Navigation.NavigateTo("/admin-login");
    }

    [JSInvokable]
    public void OnLocationSelected(int locationId)
    {
        selectedLocation = locations.FirstOrDefault(l => l.Id == locationId);
        StateHasChanged();
    }

} 